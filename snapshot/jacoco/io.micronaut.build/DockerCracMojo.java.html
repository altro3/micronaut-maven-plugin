<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DockerCracMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Micronaut Maven Plugin</a> &gt; <a href="index.source.html" class="el_package">io.micronaut.build</a> &gt; <span class="el_source">DockerCracMojo.java</span></div><h1>DockerCracMojo.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2017-2022 original authors
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.micronaut.build;

import com.github.dockerjava.api.command.BuildImageCmd;
import com.google.cloud.tools.jib.api.ImageReference;
import com.google.cloud.tools.jib.api.InvalidImageReferenceException;
import io.micronaut.build.services.ApplicationConfigurationService;
import io.micronaut.build.services.DockerService;
import io.micronaut.build.services.JibConfigurationService;
import io.micronaut.core.annotation.Experimental;
import org.apache.commons.io.IOUtils;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.apache.maven.plugins.annotations.ResolutionScope;
import org.apache.maven.project.MavenProject;
import org.apache.maven.shared.filtering.MavenFilteringException;
import org.apache.maven.shared.filtering.MavenReaderFilter;
import org.apache.maven.shared.filtering.MavenReaderFilterRequest;

import javax.inject.Inject;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Reader;
import java.io.Writer;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardOpenOption;
import java.nio.file.attribute.PosixFilePermission;
import java.util.Collections;
import java.util.EnumSet;
import java.util.Properties;
import java.util.Set;

/**
 * &lt;p&gt;Implementation of the &lt;code&gt;docker-crac&lt;/code&gt; packaging.&lt;/p&gt;
 * &lt;p&gt;&lt;strong&gt;WARNING&lt;/strong&gt;: this goal is not intended to be executed directly. Instead, specify the packaging type
 * using the &lt;code&gt;packaging&lt;/code&gt; property, eg:&lt;/p&gt;
 *
 * &lt;pre&gt;mvn package -Dpackaging=docker-crac&lt;/pre&gt;
 * &lt;p&gt;
 * This is a two stage process. First a docker image is built that runs the application under a CRaC enabled JDK. Then
 * the application is warmed up via a shell script. And then a checkpoint is taken via a signal using jcmd.
 * &lt;p&gt;
 * The second stage takes this checkpoint, and creates the final image containing it plus a run script which passes the
 * correct flags to the CRaC enabled JDK.
 *
 * @author Tim Yates
 * @since 3.5.0
 */
@Experimental
@Mojo(name = DockerCracMojo.DOCKER_CRAC_PACKAGING, requiresDependencyResolution = ResolutionScope.COMPILE_PLUS_RUNTIME)
public class DockerCracMojo extends AbstractDockerMojo {

    public static final String DOCKER_CRAC_PACKAGING = &quot;docker-crac&quot;;
    public static final String CHECKPOINT_SCRIPT_NAME = &quot;checkpoint.sh&quot;;
    public static final String WARMUP_SCRIPT_NAME = &quot;warmup.sh&quot;;
    public static final String RUN_SCRIPT_NAME = &quot;run.sh&quot;;
    public static final String DEFAULT_READINESS_COMMAND = &quot;curl --output /dev/null --silent --head http://localhost:8080&quot;;
    public static final String CRAC_READINESS_PROPERTY = &quot;crac.readiness&quot;;
    public static final String DEFAULT_CRAC_CHECKPOINT_TIMEOUT = &quot;60&quot;;
    public static final String CRAC_CHECKPOINT_NETWORK_PROPERTY = &quot;crac.checkpoint.network&quot;;
    public static final String CRAC_CHECKPOINT_TIMEOUT_PROPERTY = &quot;crac.checkpoint.timeout&quot;;

    public static final String CRAC_JAVA_VERSION = &quot;crac.java.version&quot;;
    public static final String DEFAULT_CRAC_JAVA_VERSION = &quot;17&quot;;

    public static final String CRAC_ARCHITECTURE = &quot;crac.arch&quot;;

    public static final String DEFAULT_BASE_IMAGE = &quot;ubuntu:22.04&quot;;

    public static final String ARM_ARCH = &quot;aarch64&quot;;
    public static final String X86_64_ARCH = &quot;amd64&quot;;

<span class="nc" id="L91">    private static final EnumSet&lt;PosixFilePermission&gt; POSIX_FILE_PERMISSIONS = EnumSet.of(</span>
            PosixFilePermission.OWNER_READ, PosixFilePermission.OWNER_WRITE, PosixFilePermission.OWNER_EXECUTE,
            PosixFilePermission.GROUP_READ, PosixFilePermission.GROUP_WRITE, PosixFilePermission.GROUP_EXECUTE,
            PosixFilePermission.OTHERS_READ, PosixFilePermission.OTHERS_EXECUTE
    );
    private final MavenReaderFilter mavenReaderFilter;

    @Parameter(property = DockerCracMojo.CRAC_READINESS_PROPERTY, defaultValue = DockerCracMojo.DEFAULT_READINESS_COMMAND)
    private String readinessCommand;

    @Parameter(property = DockerCracMojo.CRAC_CHECKPOINT_TIMEOUT_PROPERTY, defaultValue = DockerCracMojo.DEFAULT_CRAC_CHECKPOINT_TIMEOUT)
    private Integer checkpointTimeoutSeconds;

    @Parameter(property = DockerCracMojo.CRAC_CHECKPOINT_NETWORK_PROPERTY)
    private String checkpointNetworkName;

    @Parameter(property = DockerCracMojo.CRAC_JAVA_VERSION, defaultValue = DockerCracMojo.DEFAULT_CRAC_JAVA_VERSION)
    private String cracJavaVersion;

    @Parameter(property = DockerCracMojo.CRAC_ARCHITECTURE)
    private String cracArchitecture;

    @SuppressWarnings(&quot;CdiInjectionPointsInspection&quot;)
    @Inject
    public DockerCracMojo(
            MavenProject mavenProject,
            JibConfigurationService jibConfigurationService,
            ApplicationConfigurationService applicationConfigurationService,
            DockerService dockerService,
            MavenReaderFilter mavenReaderFilter
    ) {
<span class="nc" id="L122">        super(mavenProject, jibConfigurationService, applicationConfigurationService, dockerService);</span>
<span class="nc" id="L123">        this.mavenReaderFilter = mavenReaderFilter;</span>
<span class="nc" id="L124">    }</span>

    @Override
    public void execute() throws MojoExecutionException {
        try {
<span class="nc" id="L129">            copyDependencies();</span>

<span class="nc" id="L131">            MicronautRuntime runtime = MicronautRuntime.valueOf(micronautRuntime.toUpperCase());</span>

<span class="nc bnc" id="L133" title="All 3 branches missed.">            switch (runtime.getBuildStrategy()) {</span>
                case LAMBDA:
<span class="nc" id="L135">                    throw new MojoExecutionException(&quot;Lambda Functions are currently unsupported&quot;);</span>

                case ORACLE_FUNCTION:
<span class="nc" id="L138">                    throw new MojoExecutionException(&quot;Oracle Functions are currently unsupported&quot;);</span>

                case DEFAULT:
                default:
<span class="nc" id="L142">                    buildDockerCrac();</span>
                    break;
            }
<span class="nc" id="L145">        } catch (InvalidImageReferenceException iire) {</span>
<span class="nc" id="L146">            String message = &quot;Invalid image reference &quot;</span>
<span class="nc" id="L147">                    + iire.getInvalidReference()</span>
                    + &quot;, perhaps you should check that the reference is formatted correctly according to &quot; +
                    &quot;https://docs.docker.com/engine/reference/commandline/tag/#extended-description&quot; +
                    &quot;\nFor example, slash-separated name components cannot have uppercase letters&quot;;
<span class="nc" id="L151">            throw new MojoExecutionException(message);</span>
<span class="nc" id="L152">        } catch (IOException | IllegalArgumentException | MavenFilteringException e) {</span>
<span class="nc" id="L153">            throw new MojoExecutionException(e.getMessage(), e);</span>
<span class="nc" id="L154">        }</span>
<span class="nc" id="L155">    }</span>

    private void buildDockerCrac() throws IOException, InvalidImageReferenceException, MavenFilteringException {
<span class="nc" id="L158">        String checkpointImage = buildCheckpointDockerfile();</span>
<span class="nc" id="L159">        getLog().info(&quot;CRaC Checkpoint image: &quot; + checkpointImage);</span>
<span class="nc" id="L160">        File checkpointDir = new File(mavenProject.getBuild().getDirectory(), &quot;cr&quot;);</span>
        // We need to make this folder first, or else Docker on linux will make it as root and break clean on CI
<span class="nc" id="L162">        checkpointDir.mkdirs();</span>
<span class="nc" id="L163">        dockerService.runPrivilegedImageAndWait(</span>
                checkpointImage,
                checkpointTimeoutSeconds,
                checkpointNetworkName,
<span class="nc" id="L167">                checkpointDir.getAbsolutePath() + &quot;:/home/app/cr&quot;</span>
        );
<span class="nc" id="L169">        buildFinalDockerfile(checkpointImage);</span>
<span class="nc" id="L170">    }</span>

    private String limitArchitecture(String architecture) {
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (architecture == null) {</span>
<span class="nc" id="L174">            return null;</span>
        }
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (ARM_ARCH.equals(architecture)) {</span>
<span class="nc" id="L177">            return architecture;</span>
        }
<span class="nc" id="L179">        return X86_64_ARCH;</span>
    }

    private String buildCheckpointDockerfile() throws IOException, MavenFilteringException {
<span class="nc" id="L183">        String name = mavenProject.getArtifactId() + &quot;-crac-checkpoint&quot;;</span>
<span class="nc" id="L184">        Set&lt;String&gt; checkpointTags = Collections.singleton(name);</span>
<span class="nc" id="L185">        copyScripts(CHECKPOINT_SCRIPT_NAME, WARMUP_SCRIPT_NAME, RUN_SCRIPT_NAME);</span>
<span class="nc" id="L186">        File dockerfile = dockerService.loadDockerfileAsResource(DockerfileMojo.DOCKERFILE_CRAC_CHECKPOINT);</span>

<span class="nc" id="L188">        String systemArchitecture = limitArchitecture(System.getProperty(&quot;os.arch&quot;));</span>
<span class="nc" id="L189">        String filteredCracArchitecture = limitArchitecture(cracArchitecture);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        String finalArchitecture = filteredCracArchitecture == null ? systemArchitecture : filteredCracArchitecture;</span>

<span class="nc" id="L192">        BuildImageCmd buildImageCmd = dockerService.buildImageCmd()</span>
<span class="nc" id="L193">                .withDockerfile(dockerfile)</span>
<span class="nc" id="L194">                .withBuildArg(&quot;BASE_IMAGE&quot;, getFromImage().orElse(DEFAULT_BASE_IMAGE))</span>
<span class="nc" id="L195">                .withBuildArg(&quot;CRAC_ARCH&quot;, finalArchitecture)</span>
<span class="nc" id="L196">                .withBuildArg(&quot;CRAC_JDK_VERSION&quot;, cracJavaVersion)</span>
<span class="nc" id="L197">                .withTags(checkpointTags);</span>
<span class="nc" id="L198">        dockerService.buildImage(buildImageCmd);</span>
<span class="nc" id="L199">        return name;</span>
    }

    private void buildFinalDockerfile(String checkpointContainerId) throws IOException, InvalidImageReferenceException, MavenFilteringException {
<span class="nc" id="L203">        Set&lt;String&gt; tags = getTags();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        for (String tag : tags) {</span>
<span class="nc" id="L205">            ImageReference.parse(tag);</span>
<span class="nc" id="L206">        }</span>
<span class="nc" id="L207">        copyScripts(RUN_SCRIPT_NAME);</span>
<span class="nc" id="L208">        File dockerfile = dockerService.loadDockerfileAsResource(DockerfileMojo.DOCKERFILE_CRAC);</span>
<span class="nc" id="L209">        BuildImageCmd buildImageCmd = dockerService.buildImageCmd()</span>
<span class="nc" id="L210">                .withDockerfile(dockerfile)</span>
<span class="nc" id="L211">                .withBuildArg(&quot;BASE_IMAGE&quot;, getFromImage().orElse(DEFAULT_BASE_IMAGE))</span>
<span class="nc" id="L212">                .withBuildArg(&quot;CHECKPOINT_IMAGE&quot;, checkpointContainerId)</span>
<span class="nc" id="L213">                .withTags(getTags());</span>
<span class="nc" id="L214">        dockerService.buildImage(buildImageCmd);</span>
<span class="nc" id="L215">    }</span>

    private Properties replacementProperties(String readinessCommand, String mainClass) {
<span class="nc" id="L218">        Properties properties = new Properties();</span>
<span class="nc" id="L219">        properties.setProperty(&quot;READINESS&quot;, readinessCommand);</span>
<span class="nc" id="L220">        properties.setProperty(&quot;MAINCLASS&quot;, mainClass);</span>
<span class="nc" id="L221">        return properties;</span>
    }

    private void copyScripts(String... scriptNames) throws IOException, MavenFilteringException {
<span class="nc" id="L225">        File target = new File(mavenProject.getBuild().getDirectory(), &quot;scripts&quot;);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (!target.exists()) {</span>
<span class="nc" id="L227">            target.mkdirs();</span>
        }
<span class="nc" id="L229">        processScripts(target, replacementProperties(readinessCommand, mainClass), scriptNames);</span>
<span class="nc" id="L230">    }</span>

    private void processScripts(File target, Properties replacements, String... scriptNames) throws IOException, MavenFilteringException {
<span class="nc bnc" id="L233" title="All 2 branches missed.">        for (String script : scriptNames) {</span>
<span class="nc" id="L234">            File localOverride = new File(mavenProject.getBasedir(), script);</span>
<span class="nc" id="L235">            InputStream resourceStream = DockerCracMojo.class.getResourceAsStream(&quot;/cracScripts/&quot; + script);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">            Reader resourceReader = resourceStream == null ? null : new InputStreamReader(resourceStream);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            try (Reader reader = localOverride.exists() ? Files.newBufferedReader(localOverride.toPath()) : resourceReader) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (reader == null) {</span>
<span class="nc" id="L239">                    throw new IOException(&quot;Could not find script &quot; + script);</span>
                }
<span class="nc" id="L241">                MavenReaderFilterRequest req = new MavenReaderFilterRequest();</span>
<span class="nc" id="L242">                req.setFrom(reader);</span>
<span class="nc" id="L243">                req.setFiltering(true);</span>
<span class="nc" id="L244">                req.setAdditionalProperties(replacements);</span>
<span class="nc" id="L245">                Path outputPath = target.toPath().resolve(script);</span>
<span class="nc" id="L246">                try (Writer writer = Files.newBufferedWriter(outputPath, StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING)) {</span>
<span class="nc" id="L247">                    IOUtils.copy(mavenReaderFilter.filter(req), writer);</span>
                }
<span class="nc" id="L249">                Files.setPosixFilePermissions(outputPath, POSIX_FILE_PERMISSIONS);</span>
            }
        }
<span class="nc" id="L252">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>