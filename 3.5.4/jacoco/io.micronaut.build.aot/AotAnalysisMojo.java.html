<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AotAnalysisMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Micronaut Maven Plugin</a> &gt; <a href="index.source.html" class="el_package">io.micronaut.build.aot</a> &gt; <span class="el_source">AotAnalysisMojo.java</span></div><h1>AotAnalysisMojo.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2017-2022 original authors
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.micronaut.build.aot;

import io.micronaut.aot.std.sourcegen.AbstractStaticServiceLoaderSourceGenerator;
import io.micronaut.aot.std.sourcegen.KnownMissingTypesSourceGenerator;
import io.micronaut.build.services.CompilerService;
import io.micronaut.build.services.DependencyResolutionService;
import io.micronaut.build.services.ExecutorService;
import org.apache.commons.io.FileUtils;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.apache.maven.plugins.annotations.ResolutionScope;
import org.apache.maven.project.MavenProject;
import org.eclipse.aether.RepositorySystem;

import javax.inject.Inject;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.nio.file.Files;
import java.nio.file.NoSuchFileException;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import java.util.stream.Stream;

/**
 * &lt;p&gt;Invokes the &lt;a href=&quot;https://micronaut-projects.github.io/micronaut-aot/latest/guide/&quot;&gt;Micronaut AOT&lt;/a&gt;
 * optimizer, generating sources/classes and the effective AOT configuration properties file. Refer to the Micronaut
 * AOT documentation for more information.&lt;/p&gt;
 *
 * &lt;p&gt;&lt;strong&gt;WARNING&lt;/strong&gt;: this goal is not intended to be executed directly. Instead, enable AOT with the
 * &lt;code&gt;micronaut.aot.enabled&lt;/code&gt; property, eg:&lt;/p&gt;
 *
 * &lt;pre&gt;mvn -Dmicronaut.aot.enabled=true package&lt;/pre&gt;
 * &lt;pre&gt;mvn -Dmicronaut.aot.enabled=true mn:run&lt;/pre&gt;
 */
@Mojo(name = AotAnalysisMojo.NAME, requiresDependencyResolution = ResolutionScope.COMPILE_PLUS_RUNTIME)
public class AotAnalysisMojo extends AbstractMicronautAotCliMojo {

    public static final String NAME = &quot;aot-analysis&quot;;
    public static final String AOT_PROPERTIES_FILE_NAME = &quot;aot.properties&quot;;

    /**
     * The project's target directory.
     */
    @Parameter(defaultValue = &quot;${project.build.directory}&quot;, required = true)
    private File baseDirectory;

    /**
     * Micronaut AOT configuration file. Run the &lt;a href=&quot;aot-sample-config-mojo.html&quot;&gt;&lt;code&gt;aot-sample-config&lt;/code&gt; goal&lt;/a&gt; to
     * see all the possible options.
     */
    @Parameter(property = &quot;micronaut.aot.config&quot;, defaultValue = AOT_PROPERTIES_FILE_NAME)
    private File configFile;

    @Inject
    @SuppressWarnings(&quot;CdiInjectionPointsInspection&quot;)
    public AotAnalysisMojo(CompilerService compilerService, ExecutorService executorService, MavenProject mavenProject,
                           MavenSession mavenSession, RepositorySystem repositorySystem,
                           DependencyResolutionService dependencyResolutionService) {
<span class="nc" id="L80">        super(compilerService, executorService, mavenProject, mavenSession, repositorySystem, dependencyResolutionService);</span>
<span class="nc" id="L81">    }</span>

    @Override
    protected List&lt;String&gt; getExtraArgs() throws MojoExecutionException {
<span class="nc" id="L85">        List&lt;String&gt; args = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L86">        args.add(&quot;--output&quot;);</span>
<span class="nc" id="L87">        File generated = outputFile(&quot;generated&quot;);</span>
<span class="nc" id="L88">        args.add(generated.getAbsolutePath());</span>
<span class="nc" id="L89">        File effectiveConfigFile = writeEffectiveConfigFile();</span>
<span class="nc" id="L90">        args.add(&quot;--config&quot;);</span>
<span class="nc" id="L91">        args.add(effectiveConfigFile.getAbsolutePath());</span>
<span class="nc" id="L92">        return args;</span>
    }

    private File writeEffectiveConfigFile() throws MojoExecutionException {
<span class="nc bnc" id="L96" title="All 2 branches missed.">        File userProvidedFile = this.configFile == null ? new File(baseDirectory, AOT_PROPERTIES_FILE_NAME) : this.configFile;</span>
<span class="nc" id="L97">        Properties props = new Properties();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (userProvidedFile.exists()) {</span>
<span class="nc" id="L99">            try (InputStream in = Files.newInputStream(userProvidedFile.toPath())) {</span>
<span class="nc" id="L100">                getLog().info(&quot;Using AOT configuration file: &quot; + configFile.getAbsolutePath());</span>
<span class="nc" id="L101">                props.load(in);</span>
<span class="nc" id="L102">            } catch (IOException e) {</span>
<span class="nc" id="L103">                throw new MojoExecutionException(&quot;Unable to parse configuration file&quot;, e);</span>
<span class="nc" id="L104">            }</span>
        }
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (!props.containsKey(KnownMissingTypesSourceGenerator.OPTION.key())) {</span>
<span class="nc" id="L107">            props.put(KnownMissingTypesSourceGenerator.OPTION.key(), String.join(&quot;,&quot;, Constants.TYPES_TO_CHECK));</span>
        }
<span class="nc" id="L109">        props.computeIfAbsent(AbstractStaticServiceLoaderSourceGenerator.SERVICE_TYPES,</span>
<span class="nc" id="L110">                key -&gt; String.join(&quot;,&quot;, Constants.SERVICE_TYPES));</span>
<span class="nc" id="L111">        File effectiveConfig = outputFile(&quot;effective-&quot; + AOT_PROPERTIES_FILE_NAME);</span>
<span class="nc" id="L112">        try (OutputStream out = Files.newOutputStream(effectiveConfig.toPath())) {</span>
<span class="nc" id="L113">            props.store(out, &quot;Effective AOT configuration&quot;);</span>
<span class="nc" id="L114">        } catch (IOException e) {</span>
<span class="nc" id="L115">            throw new MojoExecutionException(&quot;Unable to parse configuration file&quot;, e);</span>
<span class="nc" id="L116">        }</span>
<span class="nc" id="L117">        return effectiveConfig;</span>
    }

    @Override
    protected void onSuccess(File outputDir) throws MojoExecutionException {
<span class="nc" id="L122">        Path generated = outputDir.toPath().resolve(&quot;generated&quot;);</span>
<span class="nc" id="L123">        Path generatedClasses = generated.resolve(&quot;classes&quot;);</span>
        try {
<span class="nc" id="L125">            FileUtils.copyDirectory(generatedClasses.toFile(), outputDirectory);</span>
<span class="nc" id="L126">            try (Stream&lt;String&gt; linesStream = Files.lines(generated.resolve(&quot;logs&quot;).resolve(&quot;resource-filter.txt&quot;))) {</span>
<span class="nc" id="L127">                linesStream.forEach(toRemove -&gt; {</span>
                    try {
<span class="nc" id="L129">                        Files.delete(outputDirectory.toPath().resolve(toRemove));</span>
<span class="nc" id="L130">                        getLog().debug(&quot;Removed &quot; + toRemove);</span>
<span class="nc" id="L131">                    } catch (IOException e) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                        if (!(e instanceof NoSuchFileException)) {</span>
<span class="nc" id="L133">                            getLog().warn(&quot;Error while deleting &quot; + toRemove, e);</span>
                        }
<span class="nc" id="L135">                    }</span>
<span class="nc" id="L136">                });</span>
            }
<span class="nc" id="L138">        } catch (IOException e) {</span>
<span class="nc" id="L139">            throw new MojoExecutionException(&quot;Error when copying the Micronaut AOT generated classes into the target directory&quot;, e);</span>
<span class="nc" id="L140">        }</span>
<span class="nc" id="L141">    }</span>

    @Override
    String getName() {
<span class="nc" id="L145">        return NAME;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>